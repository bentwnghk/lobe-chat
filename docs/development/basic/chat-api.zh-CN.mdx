# Lobe Chat API å‰åç«¯äº¤äº’é€»è¾‘

æœ¬æ–‡æ¡£è¯´æ˜äº† Mr.ğŸ†– AI API åœ¨å‰åç«¯äº¤äº’ä¸­çš„å®ç°é€»è¾‘ï¼ŒåŒ…æ‹¬äº‹ä»¶åºåˆ—å’Œæ¶‰åŠçš„æ ¸å¿ƒç»„ä»¶ã€‚

## äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Client as å‰ç«¯å®¢æˆ·ç«¯
    participant ChatService as å‰ç«¯ ChatService
    participant ChatAPI as åç«¯ Chat API
    participant AgentRuntime as AgentRuntime
    participant ModelProvider as æ¨¡å‹æä¾›å•† API
    participant PluginGateway as æ’ä»¶ç½‘å…³

    Client->>ChatService: è°ƒç”¨ createAssistantMessage
    Note over ChatService: å¤„ç†æ¶ˆæ¯ã€å·¥å…·å’Œå‚æ•°

    ChatService->>ChatService: è°ƒç”¨ getChatCompletion
    Note over ChatService: å‡†å¤‡è¯·æ±‚å‚æ•°

    ChatService->>ChatAPI: å‘é€ POST è¯·æ±‚åˆ° /webapi/chat/[provider]

    ChatAPI->>AgentRuntime: åˆå§‹åŒ– AgentRuntime
    Note over AgentRuntime: é€šè¿‡ provider å’Œ ç”¨æˆ·é…ç½®åˆ›å»ºè¿è¡Œæ—¶

    ChatAPI->>AgentRuntime: è°ƒç”¨ chat æ–¹æ³•
    AgentRuntime->>ModelProvider: å‘é€ chat completion è¯·æ±‚

    ModelProvider-->>AgentRuntime: è¿”å›æµå¼å“åº”
    AgentRuntime-->>ChatAPI: å¤„ç†å“åº”å¹¶è¿”å› stream

    ChatAPI-->>ChatService: æµå¼è¿”å› SSE å“åº”

    ChatService->>ChatService: ä½¿ç”¨ fetchSSE å¤„ç†æµå¼å“åº”
    Note over ChatService: é€šè¿‡ fetchEventSource å¤„ç†äº‹ä»¶æµ

    loop å¯¹äºæ¯ä¸ªæ•°æ®å—
        ChatService->>ChatService: å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶ (text, tool_calls, reasoning ç­‰)
        ChatService-->>Client: é€šè¿‡ onMessageHandle å›è°ƒè¿”å›å½“å‰å—
    end

    ChatService-->>Client: é€šè¿‡ onFinish å›è°ƒè¿”å›å®Œæ•´ç»“æœ

    Note over ChatService,ModelProvider: æ’ä»¶è°ƒç”¨åœºæ™¯
    ModelProvider-->>ChatService: è¿”å›åŒ…å« tool_calls çš„å“åº”
    ChatService->>ChatService: è§£æå·¥å…·è°ƒç”¨
    ChatService->>ChatService: è°ƒç”¨ runPluginApi
    ChatService->>PluginGateway: å‘é€æ’ä»¶è¯·æ±‚åˆ°ç½‘å…³
    PluginGateway-->>ChatService: è¿”å›æ’ä»¶æ‰§è¡Œç»“æœ
    ChatService->>ModelProvider: å°†æ’ä»¶ç»“æœè¿”å›ç»™æ¨¡å‹
    ModelProvider-->>ChatService: åŸºäºæ’ä»¶ç»“æœç”Ÿæˆæœ€ç»ˆå“åº”

    Note over ChatService,ModelProvider: é¢„è®¾ä»»åŠ¡åœºæ™¯
    Client->>ChatService: è§¦å‘é¢„è®¾ä»»åŠ¡(å¦‚è‡ªåŠ¨ç¿»è¯‘ã€æœç´¢ç­‰)
    ChatService->>ChatService: è°ƒç”¨ fetchPresetTaskResult
    ChatService->>ChatAPI: å‘é€é¢„è®¾ä»»åŠ¡è¯·æ±‚
    ChatAPI-->>ChatService: è¿”å›ä»»åŠ¡ç»“æœ
    ChatService-->>Client: é€šè¿‡å›è°ƒå‡½æ•°è¿”å›ç»“æœ
```

## ä¸»è¦æ­¥éª¤è¯´æ˜

1. **å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚**ï¼šå®¢æˆ·ç«¯è°ƒç”¨å‰ç«¯ ChatService çš„ createAssistantMessage æ–¹æ³•ã€‚

2. **å‰ç«¯å¤„ç†è¯·æ±‚**ï¼š

   - `src/services/chat.ts` å¯¹æ¶ˆæ¯ã€å·¥å…·å’Œå‚æ•°è¿›è¡Œé¢„å¤„ç†
   - è°ƒç”¨ getChatCompletion å‡†å¤‡è¯·æ±‚å‚æ•°
   - ä½¿ç”¨ `src/utils/fetch/fetchSSE.ts` å‘é€è¯·æ±‚åˆ°åç«¯ API

3. **åç«¯å¤„ç†è¯·æ±‚**ï¼š

   - `src/app/(backend)/webapi/chat/[provider]/route.ts` æ¥æ”¶è¯·æ±‚
   - åˆå§‹åŒ– AgentRuntime
   - æ ¹æ®ç”¨æˆ·é…ç½®å’Œæä¾›å•†åˆ›å»ºç›¸åº”çš„æ¨¡å‹å®ä¾‹

4. **æ¨¡å‹è°ƒç”¨**ï¼š

   - `src/libs/agent-runtime/AgentRuntime.ts` è°ƒç”¨ç›¸åº”æ¨¡å‹æä¾›å•†çš„ API
   - è¿”å›æµå¼å“åº”

5. **å¤„ç†å“åº”**ï¼š

   - åç«¯å°†æ¨¡å‹å“åº”è½¬æ¢ä¸º Stream è¿”å›
   - å‰ç«¯é€šè¿‡ fetchSSE å’Œ [fetchEventSource](https://github.com/Azure/fetch-event-source) å¤„ç†æµå¼å“åº”
   - å¯¹ä¸åŒç±»å‹çš„äº‹ä»¶ï¼ˆæ–‡æœ¬ã€å·¥å…·è°ƒç”¨ã€æ¨ç†ç­‰ï¼‰è¿›è¡Œå¤„ç†
   - é€šè¿‡å›è°ƒå‡½æ•°å°†ç»“æœä¼ é€’å›å®¢æˆ·ç«¯

6. **æ’ä»¶è°ƒç”¨åœºæ™¯**ï¼š

   å½“ AI æ¨¡å‹åœ¨å“åº”ä¸­è¿”å› `tool_calls` å­—æ®µæ—¶ï¼Œä¼šè§¦å‘æ’ä»¶è°ƒç”¨æµç¨‹ï¼š

   - AI æ¨¡å‹è¿”å›åŒ…å« `tool_calls` çš„å“åº”ï¼Œè¡¨æ˜éœ€è¦è°ƒç”¨å·¥å…·
   - å‰ç«¯é€šè¿‡ `internal_callPluginApi` æ–¹æ³•å¤„ç†å·¥å…·è°ƒç”¨
   - è°ƒç”¨ `runPluginApi` æ–¹æ³•æ‰§è¡Œæ’ä»¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬è·å–æ’ä»¶è®¾ç½®å’Œæ¸…å•ã€åˆ›å»ºè®¤è¯è¯·æ±‚å¤´ã€å‘é€è¯·æ±‚åˆ°æ’ä»¶ç½‘å…³
   - æ’ä»¶æ‰§è¡Œå®Œæˆåï¼Œç»“æœè¿”å›ç»™ AI æ¨¡å‹ï¼Œæ¨¡å‹åŸºäºç»“æœç”Ÿæˆæœ€ç»ˆå“åº”

   **å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

   - **æœç´¢æ’ä»¶**ï¼šå½“ç”¨æˆ·éœ€è¦è·å–å®æ—¶ä¿¡æ¯æ—¶ï¼ŒAI ä¼šè°ƒç”¨ç½‘é¡µæœç´¢æ’ä»¶æ¥è·å–æœ€æ–°æ•°æ®
   - **DALL-E æ’ä»¶**ï¼šç”¨æˆ·è¦æ±‚ç”Ÿæˆå›¾ç‰‡æ—¶ï¼ŒAI è°ƒç”¨ DALL-E æ’ä»¶åˆ›å»ºå›¾åƒ
   - **Midjourney æ’ä»¶**ï¼šæä¾›æ›´é«˜è´¨é‡çš„å›¾åƒç”Ÿæˆèƒ½åŠ›ï¼Œé€šè¿‡ API è°ƒç”¨ Midjourney æœåŠ¡

7. **é¢„è®¾ä»»åŠ¡å¤„ç†**ï¼š

   é¢„è®¾ä»»åŠ¡æ˜¯æŒ‡ç³»ç»Ÿé¢„å®šä¹‰çš„ç‰¹å®šåŠŸèƒ½ä»»åŠ¡ï¼Œé€šå¸¸åœ¨ç”¨æˆ·æ‰§è¡Œç‰¹å®šæ“ä½œæ—¶è§¦å‘ï¼ˆè€Œéå¸¸è§„èŠå¤©æµç¨‹çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚è¿™äº›ä»»åŠ¡ä½¿ç”¨ `fetchPresetTaskResult` æ–¹æ³•æ‰§è¡Œï¼Œè¯¥æ–¹æ³•ä¸æ­£å¸¸èŠå¤©æµç¨‹ç±»ä¼¼ï¼Œä½†ä¼šä½¿ç”¨ä¸“é—¨è®¾è®¡çš„æç¤ºè¯ï¼ˆprompt chainï¼‰ã€‚

   **æ‰§è¡Œæ—¶æœº**ï¼šé¢„è®¾ä»»åŠ¡ä¸»è¦åœ¨ä»¥ä¸‹åœºæ™¯è¢«è§¦å‘ï¼š

   1. **è§’è‰²ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆ**ï¼šå½“ç”¨æˆ·åˆ›å»ºæˆ–ç¼–è¾‘è§’è‰²æ—¶è§¦å‘

      - è§’è‰²å¤´åƒç”Ÿæˆï¼ˆé€šè¿‡ `autoPickEmoji` æ–¹æ³•ï¼‰
      - è§’è‰²æè¿°ç”Ÿæˆï¼ˆé€šè¿‡ `autocompleteAgentDescription` æ–¹æ³•ï¼‰
      - è§’è‰²æ ‡ç­¾ç”Ÿæˆï¼ˆé€šè¿‡ `autocompleteAgentTags` æ–¹æ³•ï¼‰
      - è§’è‰²æ ‡é¢˜ç”Ÿæˆï¼ˆé€šè¿‡ `autocompleteAgentTitle` æ–¹æ³•ï¼‰

   2. **æ¶ˆæ¯ç¿»è¯‘**ï¼šç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ç¿»è¯‘æŒ‰é’®æ—¶è§¦å‘ï¼ˆé€šè¿‡ `translateMessage` æ–¹æ³•ï¼‰

   3. **ç½‘é¡µæœç´¢**ï¼šå½“å¯ç”¨æœç´¢ä½†æ¨¡å‹ä¸æ”¯æŒå·¥å…·è°ƒç”¨æ—¶ï¼Œé€šè¿‡ `fetchPresetTaskResult` å®ç°æœç´¢åŠŸèƒ½

   **å®é™…ä»£ç ç¤ºä¾‹**ï¼š

   è§’è‰²å¤´åƒè‡ªåŠ¨ç”Ÿæˆå®ç°ï¼š

   ```ts
   // src/features/AgentSetting/store/action.ts
   autoPickEmoji: async () => {
     const { config, meta, dispatchMeta } = get();
     const systemRole = config.systemRole;

     chatService.fetchPresetTaskResult({
       onFinish: async (emoji) => {
         dispatchMeta({ type: 'update', value: { avatar: emoji } });
       },
       onLoadingChange: (loading) => {
         get().updateLoadingState('avatar', loading);
       },
       params: merge(
         get().internal_getSystemAgentForMeta(),
         chainPickEmoji([meta.title, meta.description, systemRole].filter(Boolean).join(',')),
       ),
       trace: get().getCurrentTracePayload({ traceName: TraceNameMap.EmojiPicker }),
     });
   };
   ```

   ç¿»è¯‘åŠŸèƒ½å®ç°ï¼š

   ```ts
   // src/store/chat/slices/translate/action.ts
   translateMessage: async (id, targetLang) => {
     // ...çœç•¥éƒ¨åˆ†ä»£ç ...

     // æ£€æµ‹è¯­è¨€
     chatService.fetchPresetTaskResult({
       onFinish: async (data) => {
         if (data && supportLocales.includes(data)) from = data;
         await updateMessageTranslate(id, { content, from, to: targetLang });
       },
       params: merge(translationSetting, chainLangDetect(message.content)),
       trace: get().getCurrentTracePayload({ traceName: TraceNameMap.LanguageDetect }),
     });

     // æ‰§è¡Œç¿»è¯‘
     chatService.fetchPresetTaskResult({
       onMessageHandle: (chunk) => {
         if (chunk.type === 'text') {
           content = chunk.text;
           internal_dispatchMessage({
             id,
             type: 'updateMessageTranslate',
             value: { content, from, to: targetLang },
           });
         }
       },
       onFinish: async () => {
         await updateMessageTranslate(id, { content, from, to: targetLang });
         internal_toggleChatLoading(false, id, n('translateMessage(end)', { id }) as string);
       },
       params: merge(translationSetting, chainTranslate(message.content, targetLang)),
       trace: get().getCurrentTracePayload({ traceName: TraceNameMap.Translation }),
     });
   };
   ```

8. **å®Œæˆ**ï¼š
   - å½“æµç»“æŸæ—¶ï¼Œè°ƒç”¨ onFinish å›è°ƒï¼Œæä¾›å®Œæ•´çš„å“åº”ç»“æœ

## AgentRuntime è¯´æ˜

AgentRuntime æ˜¯ Lobe Chat ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæŠ½è±¡å±‚ï¼Œå®ƒå°è£…äº†ä¸ä¸åŒ AI æ¨¡å‹æä¾›å•†äº¤äº’çš„ç»Ÿä¸€æ¥å£ã€‚å…¶ä¸»è¦èŒè´£å’Œç‰¹ç‚¹åŒ…æ‹¬ï¼š

1. **ç»Ÿä¸€æŠ½è±¡å±‚**ï¼šAgentRuntime æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œéšè—äº†ä¸åŒ AI æä¾›å•† API çš„å®ç°ç»†èŠ‚å·®å¼‚ï¼ˆå¦‚ OpenAIã€Anthropicã€Bedrock ç­‰ï¼‰ã€‚

2. **æ¨¡å‹åˆå§‹åŒ–**ï¼šé€šè¿‡ `initializeWithProvider` é™æ€æ–¹æ³•ï¼Œæ ¹æ®æŒ‡å®šçš„æä¾›å•†å’Œé…ç½®å‚æ•°åˆå§‹åŒ–å¯¹åº”çš„è¿è¡Œæ—¶å®ä¾‹ã€‚

3. **èƒ½åŠ›å°è£…**ï¼š

   - `chat` æ–¹æ³•ï¼šå¤„ç†èŠå¤©æµå¼è¯·æ±‚
   - `models` æ–¹æ³•ï¼šè·å–æ¨¡å‹åˆ—è¡¨
   - æ”¯æŒæ–‡æœ¬åµŒå…¥ã€æ–‡æœ¬åˆ°å›¾åƒã€æ–‡æœ¬åˆ°è¯­éŸ³ç­‰åŠŸèƒ½ï¼ˆå¦‚æœæ¨¡å‹æä¾›å•†æ”¯æŒï¼‰

4. **æ’ä»¶åŒ–æ¶æ„**ï¼šé€šè¿‡ `src/libs/agent-runtime/runtimeMap.ts` æ˜ å°„è¡¨ï¼Œå®ç°äº†å¯æ‰©å±•çš„æ’ä»¶åŒ–æ¶æ„ï¼Œæ–¹ä¾¿æ·»åŠ æ–°çš„æ¨¡å‹æä¾›å•†ã€‚ç›®å‰æ”¯æŒè¶…è¿‡ 40 ä¸ªä¸åŒçš„æ¨¡å‹æä¾›å•†ï¼š

   ```ts
   export const providerRuntimeMap = {
     openai: LobeOpenAI,
     anthropic: LobeAnthropicAI,
     google: LobeGoogleAI,
     azure: LobeAzureOpenAI,
     bedrock: LobeBedrockAI,
     ollama: LobeOllamaAI,
     // ...å…¶ä»–40å¤šä¸ªæ¨¡å‹æä¾›å•†
   };
   ```

5. **é€‚é…å™¨æ¨¡å¼**ï¼šåœ¨å†…éƒ¨ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œå°†ä¸åŒæä¾›å•†çš„ API é€‚é…åˆ°ç»Ÿä¸€çš„ `src/libs/agent-runtime/BaseAI.ts` æ¥å£ï¼š

   ```ts
   export interface LobeRuntimeAI {
     baseURL?: string;
     chat(payload: ChatStreamPayload, options?: ChatCompetitionOptions): Promise<Response>;
     embeddings?(payload: EmbeddingsPayload, options?: EmbeddingsOptions): Promise<Embeddings[]>;
     models?(): Promise<any>;
     textToImage?: (payload: TextToImagePayload) => Promise<string[]>;
     textToSpeech?: (
       payload: TextToSpeechPayload,
       options?: TextToSpeechOptions,
     ) => Promise<ArrayBuffer>;
   }
   ```

   **é€‚é…å™¨å®ç°ç¤ºä¾‹**ï¼š

   1. **OpenRouter é€‚é…å™¨**ï¼š
      OpenRouter æ˜¯ä¸€ä¸ªç»Ÿä¸€ APIï¼Œå¯ä»¥é€šè¿‡å®ƒè®¿é—®å¤šä¸ªæ¨¡å‹æä¾›å•†çš„ AI æ¨¡å‹ã€‚Lobe Chat é€šè¿‡é€‚é…å™¨å®ç°å¯¹ OpenRouter çš„æ”¯æŒï¼š

      ```ts
      // OpenRouter é€‚é…å™¨å®ç°
      class LobeOpenRouterAI implements LobeRuntimeAI {
        client: OpenAI;
        baseURL: string;

        constructor(options: OpenAICompatibleOptions) {
          // åˆå§‹åŒ– OpenRouter å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ OpenAI å…¼å®¹çš„ API
          this.client = new OpenAI({
            apiKey: options.apiKey,
            baseURL: OPENROUTER_BASE_URL,
            defaultHeaders: {
              'HTTP-Referer': 'https://github.com/lobehub/lobe-chat',
              'X-Title': 'LobeChat',
            },
          });
          this.baseURL = OPENROUTER_BASE_URL;
        }

        // å®ç°èŠå¤©åŠŸèƒ½
        async chat(payload: ChatCompletionCreateParamsBase, options?: RequestOptions) {
          // å°† Lobe Chat çš„è¯·æ±‚æ ¼å¼è½¬æ¢ä¸º OpenRouter æ ¼å¼
          // å¤„ç†æ¨¡å‹æ˜ å°„ã€æ¶ˆæ¯æ ¼å¼ç­‰
          return this.client.chat.completions.create(
            {
              ...payload,
              model: payload.model || 'openai/gpt-4-turbo', // é»˜è®¤æ¨¡å‹
            },
            options,
          );
        }

        // å®ç°å…¶ä»– LobeRuntimeAI æ¥å£æ–¹æ³•
      }
      ```

   2. **Google Gemini é€‚é…å™¨**ï¼š
      Gemini æ˜¯ Google çš„å¤§è¯­è¨€æ¨¡å‹ï¼ŒLobe Chat é€šè¿‡ä¸“é—¨çš„é€‚é…å™¨æ”¯æŒ Gemini ç³»åˆ—æ¨¡å‹ï¼š

      ```ts
      import { GoogleGenerativeAI } from '@google/generative-ai';

      // Gemini é€‚é…å™¨å®ç°
      class LobeGoogleAI implements LobeRuntimeAI {
        client: GoogleGenerativeAI;
        baseURL: string;
        apiKey: string;

        constructor(options: GoogleAIOptions) {
          // åˆå§‹åŒ– Google Generative AI å®¢æˆ·ç«¯
          this.client = new GoogleGenerativeAI(options.apiKey);
          this.apiKey = options.apiKey;
          this.baseURL = options.baseURL || GOOGLE_AI_BASE_URL;
        }

        // å®ç°èŠå¤©åŠŸèƒ½
        async chat(payload: ChatCompletionCreateParamsBase, options?: RequestOptions) {
          // é€‰æ‹©åˆé€‚çš„æ¨¡å‹ï¼ˆæ”¯æŒ Gemini Proã€Gemini Flash ç­‰ï¼‰
          const modelName = payload.model || 'gemini-pro';
          const model = this.client.getGenerativeModel({ model: modelName });

          // å¤„ç†å¤šæ¨¡æ€è¾“å…¥ï¼ˆå¦‚å›¾åƒï¼‰
          const contents = this.processMessages(payload.messages);

          // è®¾ç½®ç”Ÿæˆå‚æ•°
          const generationConfig = {
            temperature: payload.temperature,
            topK: payload.top_k,
            topP: payload.top_p,
            maxOutputTokens: payload.max_tokens,
          };

          // åˆ›å»ºèŠå¤©ä¼šè¯å¹¶è·å–å“åº”
          const chat = model.startChat({
            generationConfig,
            history: contents.slice(0, -1),
            safetySettings: this.getSafetySettings(payload),
          });

          // å¤„ç†æµå¼å“åº”
          return this.handleStreamResponse(chat, contents, options?.signal);
        }

        // å®ç°å…¶ä»–å¤„ç†æ–¹æ³•
        private processMessages(messages) {
          /* ... */
        }
        private getSafetySettings(payload) {
          /* ... */
        }
        private handleStreamResponse(chat, contents, signal) {
          /* ... */
        }
      }
      ```

   **ä¸åŒæ¨¡å‹çš„é€‚é…å®ç°**ï¼š

- `src/libs/agent-runtime/openai/index.ts` - OpenAI å®ç°
- `src/libs/agent-runtime/anthropic/index.ts` - Anthropic å®ç°
- `src/libs/agent-runtime/google/index.ts` - Google å®ç°
- `src/libs/agent-runtime/openrouter/index.ts` - OpenRouter å®ç°

è¯¦ç»†å®ç°å¯ä»¥æŸ¥çœ‹ï¼š

- `src/libs/agent-runtime/AgentRuntime.ts` - æ ¸å¿ƒè¿è¡Œæ—¶ç±»
- `src/libs/agent-runtime/BaseAI.ts` - å®šä¹‰åŸºç¡€æ¥å£
- `src/libs/agent-runtime/runtimeMap.ts` - æä¾›å•†æ˜ å°„è¡¨
- `src/libs/agent-runtime/UniformRuntime/index.ts` - å¤„ç†å¤šæ¨¡å‹ç»Ÿä¸€è¿è¡Œæ—¶
- `src/libs/agent-runtime/utils/openaiCompatibleFactory/index.ts` - OpenAI å…¼å®¹é€‚é…å™¨å·¥å‚
