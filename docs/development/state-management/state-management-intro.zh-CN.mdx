{/* eslint-disable no-irregular-whitespace */}

# çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

Mr.ğŸ†– AI ä¸åŒäºä¼ ç»Ÿ CRUD çš„ç½‘é¡µï¼Œå­˜åœ¨å¤§é‡çš„å¯Œäº¤äº’èƒ½åŠ›ï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªæ˜“äºå¼€å‘ä¸æ˜“äºç»´æŠ¤çš„æ•°æ®æµæ¶æ„éå¸¸é‡è¦ã€‚æœ¬ç¯‡æ–‡æ¡£å°†ä»‹ç» Mr.ğŸ†– AI ä¸­çš„æ•°æ®æµç®¡ç†æœ€ä½³å®è·µã€‚

## æ¦‚å¿µè¦ç´ 

| æ¦‚å¿µåè¯     | è§£é‡Š                                                                                                                                                   |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| store    | çŠ¶æ€åº“ (store)ï¼ŒåŒ…å«å­˜å‚¨åº”ç”¨çš„çŠ¶æ€ã€åŠ¨ä½œã€‚å…è®¸åœ¨åº”ç”¨æ¸²æŸ“ä¸­è®¿é—®å’Œä¿®æ”¹çŠ¶æ€ã€‚                                                                                                            |
| state    | çŠ¶æ€ (state) æ˜¯æŒ‡åº”ç”¨ç¨‹åºçš„æ•°æ®ï¼Œå­˜å‚¨äº†åº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€ï¼ŒçŠ¶æ€çš„å˜åŒ–**ä¸€å®šä¼šè§¦å‘åº”ç”¨çš„é‡æ–°æ¸²æŸ“**ï¼Œä»¥åæ˜ æ–°çš„çŠ¶æ€ã€‚                                                                                     |
| action   | åŠ¨ä½œ (action) æ˜¯ä¸€ä¸ªæ“ä½œå‡½æ•°ï¼Œå®ƒæè¿°äº†åº”ç”¨ç¨‹åºä¸­å‘ç”Ÿçš„äº¤äº’äº‹ä»¶ã€‚åŠ¨ä½œé€šå¸¸æ˜¯ç”±ç”¨æˆ·äº¤äº’ã€ç½‘ç»œè¯·æ±‚æˆ–å®šæ—¶å™¨ç­‰è§¦å‘ã€‚ action å¯ä»¥æ˜¯**åŒæ­¥**çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯**å¼‚æ­¥**çš„ã€‚                                                          |
| reducer  | å½’çº¦å™¨ (reducer) æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œå®ƒæ¥æ”¶å½“å‰çŠ¶æ€å’ŒåŠ¨ä½œä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„çŠ¶æ€ã€‚å®ƒç”¨äºæ ¹æ®åŠ¨ä½œç±»å‹æ¥æ›´æ–°åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚Reducer æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œä¸å­˜åœ¨å‰¯ä½œç”¨ï¼Œå› æ­¤ä¸€å®šæ˜¯ **åŒæ­¥** å‡½æ•°ã€‚                                             |
| selector | é€‰æ‹©å™¨ (selector) æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºä»åº”ç”¨ç¨‹åºçš„çŠ¶æ€ä¸­è·å–ç‰¹å®šçš„æ•°æ®ã€‚å®ƒæ¥æ”¶åº”ç”¨ç¨‹åºçš„çŠ¶æ€ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ç»è¿‡è®¡ç®—æˆ–è½¬æ¢åçš„æ•°æ®ã€‚Selector å¯ä»¥å°†çŠ¶æ€çš„ä¸€éƒ¨åˆ†æˆ–å¤šä¸ªçŠ¶æ€ç»„åˆèµ·æ¥ï¼Œä»¥ç”Ÿæˆæ´¾ç”Ÿçš„æ•°æ®ã€‚Selector é€šå¸¸ç”¨äºå°†åº”ç”¨ç¨‹åºçš„çŠ¶æ€æ˜ å°„åˆ°ç»„ä»¶çš„ propsï¼Œä»¥ä¾›ç»„ä»¶ä½¿ç”¨ã€‚ |
| slice    | åˆ‡ç‰‡ (slice) æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œç”¨äºè¡¨è¾¾æ•°æ®æ¨¡å‹çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚å®ƒæŒ‡å®šäº†ä¸€ä¸ªçŠ¶æ€åˆ‡ç‰‡ï¼ˆsliceï¼‰ï¼Œä»¥åŠä¸è¯¥åˆ‡ç‰‡ç›¸å…³çš„ stateã€actionã€reducer å’Œ selectorã€‚ä½¿ç”¨ Slice å¯ä»¥å°†å¤§å‹çš„ Store æ‹†åˆ†ä¸ºæ›´å°çš„ã€å¯ç»´æŠ¤çš„å­ç±»å‹ã€‚                    |

## ç»“æ„åˆ†å±‚

åœ¨ä¸åŒçš„å¤æ‚åº¦ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°† Store çš„ç»“æ„ç»„ç»‡å¯ä»¥ç”±å¾ˆå¤§çš„ä¸åŒï¼š

- **è¾ƒä½å¤æ‚åº¦**ï¼šä¸€èˆ¬åŒ…å« 2\~5 ä¸ª state ã€3 \~ 4 ä¸ª actionã€‚æ­¤æ—¶çš„ç»“æ„ä¸€èˆ¬ç›´æ¥ä¸€ä¸ª `store.ts` + ä¸€ä¸ª `initialState.ts` å³å¯ã€‚

```bash
DataFill/store
â”œâ”€â”€ index.ts
â””â”€â”€ initialState.ts
```

- **ä¸€èˆ¬å¤æ‚åº¦** ï¼šä¸€èˆ¬å¤æ‚åº¦å­˜åœ¨ 5 \~ 15 ä¸ª stateã€ 5 \~ 10 ä¸ª actionï¼Œå¯èƒ½ä¼šå­˜åœ¨ selector å®ç°æ´¾ç”ŸçŠ¶æ€ï¼Œä¹Ÿæœ‰å¯èƒ½å­˜åœ¨ reducer ç®€åŒ–éƒ¨åˆ†æ•°æ®å˜æ›´çš„å¤æ‚åº¦ã€‚æ­¤æ—¶çš„ç»“æ„ä¸€èˆ¬ä¸ºä¸€ä¸ª `store.ts` + ä¸€ä¸ª `initialState.ts` + ä¸€ä¸ª `selectors.ts`/`reducer.ts`ã€‚

```bash
IconPicker/store
â”œâ”€â”€ index.ts
â”œâ”€â”€ initialState.ts
â”œâ”€â”€ selectors.ts
â””â”€â”€ store.ts
```

```bash
SortableList/store
â”œâ”€â”€ index.ts
â”œâ”€â”€ initialState.ts
â”œâ”€â”€ listDataReducer.ts
â””â”€â”€ store.ts
```

- **ä¸­ç­‰å¤æ‚åº¦** ï¼š ä¸­ç­‰å¤æ‚åº¦å­˜åœ¨ 15 \~ 30 ä¸ª stateã€ 10 \~ 20 ä¸ª actionï¼Œå¤§æ¦‚ç‡ä¼šå­˜åœ¨ selector æ¥èšåˆæ´¾ç”ŸçŠ¶æ€ï¼Œå¤§æ¦‚ç‡å­˜åœ¨ reducer ç®€åŒ–éƒ¨åˆ†æ•°æ®å˜æ›´çš„å¤æ‚åº¦ã€‚

æ­¤æ—¶ç»“æ„ï¼Œç”¨å•ä¸€çš„ action store å·²ç»è¾ƒéš¾ç»´æŠ¤ï¼Œå¾€å¾€ä¼šæ‹†è§£å‡ºæ¥å¤šä¸ª slice ç”¨äºç®¡ç†ä¸åŒçš„ actionã€‚ ä¸‹æ–¹çš„ä»£ç ä»£è¡¨äº† `SortableTree` ç»„ä»¶çš„å†…éƒ¨æ•°æ®æµï¼š

```bash
SortableTree/store
â”œâ”€â”€ index.ts
â”œâ”€â”€ initialState.ts
â”œâ”€â”€ selectors.ts
â”œâ”€â”€ slices
â”œâ”€â”€ crudSlice.ts
â”œâ”€â”€ dndSlice.ts
â””â”€â”€ selectionSlice.ts
â”œâ”€â”€ store.ts
â””â”€â”€ treeDataReducer.ts
```

- é«˜ç­‰å¤æ‚åº¦ï¼šé«˜ç­‰å¤æ‚åº¦å­˜åœ¨ 30 ä¸ªä»¥ä¸Šçš„ stateã€ 20 ä¸ªä»¥ä¸Šçš„ actionã€‚å¿…ç„¶éœ€è¦ slice åšæ¨¡å—åŒ–å†…èšã€‚åœ¨æ¯ä¸ª slice ä¸­éƒ½å„è‡ªå£°æ˜äº†å„è‡ªçš„ initStateã€ actionã€reducer ä¸ selectorã€‚

ä¸‹è¿°è¿™ä¸ªæ•°æ®æµçš„ç›®å½•ç»“æ„æ˜¯ä¹‹å‰ä¸€ç‰ˆ SessionStoreï¼Œå…·æœ‰å¾ˆé«˜çš„å¤æ‚åº¦ï¼Œå®ç°äº†å¤§é‡çš„ä¸šåŠ¡é€»è¾‘ã€‚ä½†å€ŸåŠ©äº slice çš„æ¨¡å—åŒ–å’Œåˆ†å½¢æ¶æ„çš„å¿ƒæ™ºï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰¾åˆ°å¯¹åº”çš„æ¨¡å—ï¼Œæ–°å¢åŠŸèƒ½ä¸è¿­ä»£éƒ½å¾ˆæ˜“äºç»´æŠ¤ã€‚

```bash
Mr.ğŸ†– AI SessionStore
â”œâ”€â”€ index.ts
â”œâ”€â”€ initialState.ts
â”œâ”€â”€ selectors.ts
â”œâ”€â”€ slices
â”‚ â”œâ”€â”€ agentConfig
â”‚ â”‚ â”œâ”€â”€ action.ts
â”‚ â”‚ â”œâ”€â”€ index.ts
â”‚ â”‚ â”œâ”€â”€ initialState.ts
â”‚ â”‚ â””â”€â”€ selectors.ts
â”‚ â”œâ”€â”€ chat
â”‚ â”‚ â”œâ”€â”€ actions
â”‚ â”‚ â”‚ â”œâ”€â”€ index.ts
â”‚ â”‚ â”‚ â”œâ”€â”€ message.ts
â”‚ â”‚ â”‚ â””â”€â”€ topic.ts
â”‚ â”‚ â”œâ”€â”€ index.ts
â”‚ â”‚ â”œâ”€â”€ initialState.ts
â”‚ â”‚ â”œâ”€â”€ reducers
â”‚ â”‚ â”‚ â”œâ”€â”€ message.ts
â”‚ â”‚ â”‚ â””â”€â”€ topic.ts
â”‚ â”‚ â”œâ”€â”€ selectors
â”‚ â”‚ â”‚ â”œâ”€â”€ chat.ts
â”‚ â”‚ â”‚ â”œâ”€â”€ index.ts
â”‚ â”‚ â”‚ â”œâ”€â”€ token.ts
â”‚ â”‚ â”‚ â”œâ”€â”€ topic.ts
â”‚ â”‚ â”‚ â””â”€â”€ utils.ts
â”‚ â”‚ â””â”€â”€ utils.ts
â”‚ â””â”€â”€ session
â”‚ â”œâ”€â”€ action.ts
â”‚ â”œâ”€â”€ index.ts
â”‚ â”œâ”€â”€ initialState.ts
â”‚ â”œâ”€â”€ reducers
â”‚ â”‚ â””â”€â”€ session.ts
â”‚ â””â”€â”€ selectors
â”‚ â”œâ”€â”€ export.ts
â”‚ â”œâ”€â”€ index.ts
â”‚ â””â”€â”€ list.ts
â””â”€â”€ store.ts
```

### Mr.ğŸ†– AI SessionStore ç›®å½•ç»“æ„æœ€ä½³å®è·µ

åœ¨ Mr.ğŸ†– AI åº”ç”¨ä¸­ï¼Œç”±äºä¼šè¯ç®¡ç†æ˜¯ä¸€ä¸ªå¤æ‚çš„åŠŸèƒ½æ¨¡å—ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨äº† [slice æ¨¡å¼](https://github.com/pmndrs/zustand/blob/main/docs/guides/slices-pattern.md) æ¥ç»„ç»‡æ•°æ®æµã€‚ä¸‹é¢æ˜¯ Mr.ğŸ†– AI SessionStore çš„ç›®å½•ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªç›®å½•å’Œæ–‡ä»¶éƒ½æœ‰å…¶ç‰¹å®šçš„ç”¨é€”ï¼š

```fish
src/store/session
â”œâ”€â”€ index.ts                           # SessionStore çš„èšåˆå¯¼å‡ºæ–‡ä»¶
â”œâ”€â”€ initialState.ts                    # èšåˆäº†æ‰€æœ‰ slice çš„ initialState
â”œâ”€â”€ selectors.ts                       # ä»å„ä¸ª slices å¯¼å‡ºçš„ selector
â”œâ”€â”€ store.ts                           # SessionStore çš„åˆ›å»ºå’Œä½¿ç”¨
â”œâ”€â”€ helpers.ts                         # è¾…åŠ©å‡½æ•°
â””â”€â”€ slices                             # å„ä¸ªç‹¬ç«‹çš„åŠŸèƒ½åˆ‡ç‰‡
 Â Â  â”œâ”€â”€ agent                          # åŠ©ç† Slice
 Â Â  â”‚Â Â  â”œâ”€â”€ action.ts
 Â Â  â”‚Â Â  â”œâ”€â”€ index.ts
 Â Â  â”‚Â Â  â””â”€â”€ selectors.ts
 Â Â  â””â”€â”€ session                        # ä¼šè¯ Slice
 Â Â   Â Â  â”œâ”€â”€ action.ts
 Â Â   Â Â  â”œâ”€â”€ helpers.ts
 Â Â   Â Â  â”œâ”€â”€ initialState.ts
 Â Â   Â Â  â””â”€â”€ selectors
 Â Â   Â Â   Â Â  â”œâ”€â”€ export.ts
 Â Â   Â Â   Â Â  â”œâ”€â”€ list.ts
 Â Â   Â Â   Â Â  â””â”€â”€ index.ts

```

## SessionStore çš„å®ç°

åœ¨ Mr.ğŸ†– AI ä¸­ï¼ŒSessionStore è¢«è®¾è®¡ä¸ºç®¡ç†ä¼šè¯çŠ¶æ€å’Œé€»è¾‘çš„æ ¸å¿ƒæ¨¡å—ã€‚å®ƒç”±å¤šä¸ª Slices ç»„æˆï¼Œæ¯ä¸ª Slice ç®¡ç†ä¸€éƒ¨åˆ†ç›¸å…³çš„çŠ¶æ€å’Œé€»è¾‘ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ SessionStore çš„å®ç°ç¤ºä¾‹ï¼š

### store.ts

```ts
import { PersistOptions, devtools, persist, subscribeWithSelector } from 'zustand/middleware';
import { shallow } from 'zustand/shallow';
import { devtools } from 'zustand/middleware';
import { createWithEqualityFn } from 'zustand/traditional';

import { SessionStoreState, initialState } from './initialState';
import { AgentAction, createAgentSlice } from './slices/agent/action';
import { SessionAction, createSessionSlice } from './slices/session/action';

//  ===============  èšåˆ createStoreFn ============ //

export type SessionStore = SessionAction & AgentAction & SessionStoreState;
const createStore: StateCreator<SessionStore, [['zustand/devtools', never]]> = (...parameters) => ({
  ...initialState,
  ...createAgentSlice(...parameters),
  ...createSessionSlice(...parameters),
});



//  ===============  å®è£… useStore ============ //

export const useSessionStore = createWithEqualityFn<SessionStore>()(
  persist(
    subscribeWithSelector(
      devtools(createStore, {
        name: 'Mr.ğŸ†– AI_Session' + (isDev ? '_DEV' : ''),
      }),
    ),
    persistOptions,
  ),
  shallow,
);

```

åœ¨è¿™ä¸ª `store.ts` æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª `useSessionStore` é’©å­ï¼Œå®ƒä½¿ç”¨ `zustand` åº“æ¥åˆ›å»ºä¸€ä¸ªå…¨å±€çŠ¶æ€ç®¡ç†å™¨ã€‚æˆ‘ä»¬å°† initialState å’Œæ¯ä¸ª Slice çš„åŠ¨ä½œåˆå¹¶ï¼Œä»¥åˆ›å»ºå®Œæ•´çš„ SessionStoreã€‚

### slices/session/action.ts

```ts
import { StateCreator } from 'zustand';

import { SessionStore } from '@/store/session';

export interface SessionActions {
  /**
   * A custom hook that uses SWR to fetch sessions data.
   */
  useFetchSessions: () => SWRResponse<any>;
}

export const createSessionSlice: StateCreator<
  SessionStore,
  [['zustand/devtools', never]],
  [],
  SessionAction
> = (set, get) => ({
  useFetchSessions: () => {
    // ...åˆå§‹åŒ–ä¼šè¯çš„é€»è¾‘
  },
  // ...å…¶ä»–åŠ¨ä½œçš„å®ç°
});
```

åœ¨ `action.ts` æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `SessionActions` æ¥å£æ¥æè¿°ä¼šè¯ç›¸å…³çš„åŠ¨ä½œï¼Œå¹¶ä¸”å®ç°äº†ä¸€ä¸ª `useFetchSessions` å‡½æ•°æ¥åˆ›å»ºè¿™äº›åŠ¨ä½œã€‚ç„¶åï¼Œæˆ‘ä»¬å°†è¿™äº›åŠ¨ä½œä¸åˆå§‹çŠ¶æ€åˆå¹¶ï¼Œä»¥å½¢æˆä¼šè¯ç›¸å…³çš„ Sliceã€‚

é€šè¿‡è¿™ç§ç»“æ„åˆ†å±‚å’Œæ¨¡å—åŒ–çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ Mr.ğŸ†– AI çš„ SessionStore æ˜¯æ¸…æ™°ã€å¯ç»´æŠ¤çš„ï¼ŒåŒæ—¶ä¹Ÿä¾¿äºæ‰©å±•å’Œæµ‹è¯•ã€‚
